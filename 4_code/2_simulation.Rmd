---
title: "SIM"
output: html_document
---

This code simulates data based on the variance estimates. The data can be used to run the analysis code ("1_data_processing.Rmd").

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library("tidyverse")

#devtools::install_github("sdparsons/iced")
#remotes::install_github("")
library("ICED")



between_error_CT <- read.csv("2_analysis_output/between_error_CT.csv")
between_error_SA <- read.csv("2_analysis_output/between_error_SA.csv")
between_error_GM <- read.csv("2_analysis_output/between_error_GM.csv")

site_ns <- read.csv("2_analysis_output/site_ns.csv")

```


```{r CT}
# Cortical thickness

sites <- sort(unique(between_error_CT$site))
site_count <- 1
out2_CT <- NULL
for(ABCDsite in sites) {
  
tmp_dat <- subset(between_error_CT, site == ABCDsite)

n <- site_ns[site_count, "n"]

out_CT <- data.frame(ppid = 1:n)

for(i in unique(between_error_CT$ROI)) {

struc <- data.frame(time = c(paste(i,"T1",sep = ""),
                             paste(i, "T2",sep = "")))  
  

tmp <- sim_ICED(structure = struc,
                variances = list(time = tmp_dat[which(tmp_dat$ROI == i),"time_var"],
                e = tmp_dat[which(tmp_dat$ROI == i),"error_var"]), 
                n = n)

out_CT <- cbind(out_CT, tmp$data)

}
out2_CT <- rbind(out2_CT, cbind(ABCDsite, out_CT))

site_count <- site_count + 1
}

out2_CT$ppid <- 1:nrow(out2_CT)
 
out2_CT <- out2_CT %>%
  add_column(.before = "ABCDsite",
             measure = "Cortical Thickness")

write.csv(out2_CT, "3_simulated_data/CT_sim.csv",
          row.names = FALSE)

```

```{r SA}
sites <- sort(unique(between_error_SA$site))
site_count <- 1
out2_SA <- NULL
for(ABCDsite in sites) {
  
tmp_dat <- subset(between_error_SA, site == ABCDsite)

n <- site_ns[site_count, "n"]

out_SA <- data.frame(ppid = 1:n)

for(i in unique(between_error_SA$ROI)) {

struc <- data.frame(time = c(paste(i,"T1",sep = ""),
                             paste(i, "T2",sep = "")))  
  

tmp <- sim_ICED(structure = struc,
                variances = list(time = tmp_dat[which(tmp_dat$ROI == i),"time_var"],
                e = tmp_dat[which(tmp_dat$ROI == i),"error_var"]), 
                n = n)

out_SA <- cbind(out_SA, tmp$data)

}
out2_SA <- rbind(out2_SA, cbind(ABCDsite, out_SA))

site_count <- site_count + 1
}

out2_SA$ppid <- 1:nrow(out2_SA)
 
out2_SA <- out2_SA %>%
  add_column(.before = "ABCDsite",
             measure = "Surface Area")

write.csv(out2_SA, "3_simulated_data/SA_sim.csv",
          row.names = FALSE)

```

```{r GM}
sites <- sort(unique(between_error_GM$site))
site_count <- 1
out2_GM <- NULL
for(ABCDsite in sites) {
  
tmp_dat <- subset(between_error_GM, site == ABCDsite)

n <- site_ns[site_count, "n"]

out_GM <- data.frame(ppid = 1:n)

for(i in unique(between_error_GM$ROI)) {

struc <- data.frame(time = c(paste(i,"T1",sep = ""),
                             paste(i, "T2",sep = "")))  
  

tmp <- sim_ICED(structure = struc,
                variances = list(time = tmp_dat[which(tmp_dat$ROI == i),"time_var"],
                e = tmp_dat[which(tmp_dat$ROI == i),"error_var"]), 
                n = n)

out_GM <- cbind(out_GM, tmp$data)

}
out2_GM <- rbind(out2_GM, cbind(ABCDsite, out_GM))

site_count <- site_count + 1
}

out2_GM$ppid <- 1:nrow(out2_GM)
 
out2_GM <- out2_GM %>%
  add_column(.before = "ABCDsite",
             measure = "Grey Matter Volume")

write.csv(out2_GM, "3_simulated_data/GM_sim.csv",
          row.names = FALSE)

```
