---
title: "ABCD applied analyses"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library("tidyverse")
library("ggseg")
library("patchwork")
library("corrplot")
library("Cairo")
library("pwr")

```

```{r read_data}

# use simulated data? if set to TRUE then the simulated data will be used and results saved under different file names
use_sim = TRUE

if(use_sim == FALSE) {

# ICC and ICC2 results
out_CT <- read.csv("2_analysis_output/out_CT.csv")
out_SA <- read.csv("2_analysis_output/out_SA.csv")
out_GM <- read.csv("2_analysis_output/out_GM.csv")

#between and within variance estimates (per site) results
between_error_CT <- read.csv("2_analysis_output/between_error_CT.csv")
between_error_SA <- read.csv("2_analysis_output/between_error_SA.csv")
between_error_GM <- read.csv("2_analysis_output/between_error_GM.csv")

# LRT results from multisite
sites_LRTs_CT_tidy <- read.csv("2_analysis_output/sites_LRTs_CT_tidy_aicbic.csv")
sites_LRTs_SA_tidy <- read.csv("2_analysis_output/sites_LRTs_SA_tidy_aicbic.csv")
sites_LRTs_GM_tidy <- read.csv("2_analysis_output/sites_LRTs_GM_tidy_aicbic.csv")

# improved LRT results and CFIS
sites_LRTs_CT_tidy_aicbic <- read.csv("2_analysis_output/sites_LRTs_CT_tidy_aicbic.csv")
multigroup_CFIs_CT <- read.csv("2_analysis_output/multigroup_CFIs_CT.csv")
sites_LRTs_SA_tidy_aicbic <- read.csv("2_analysis_output/sites_LRTs_SA_tidy_aicbic.csv")
multigroup_CFIs_SA <- read.csv("2_analysis_output/multigroup_CFIs_SA.csv")
sites_LRTs_GM_tidy_aicbic <- read.csv("2_analysis_output/sites_LRTs_GM_tidy_aicbic.csv")
multigroup_CFIs_GM <- read.csv("2_analysis_output/multigroup_CFIs_GM.csv")

# scanner multigroup results
multigroup_CFIs_CT_scanners <- read.csv("2_analysis_output/multigroup_CFIs_CT_scanners.csv")
multigroup_CFIs_SA_scanners <- read.csv("2_analysis_output/multigroup_CFIs_SA_scanners.csv")
multigroup_CFIs_GM_scanners <- read.csv("2_analysis_output/multigroup_CFIs_GM_scanners.csv")

between_error_CT_scanner <- read.csv("2_analysis_output/between_error_CT_scanner.csv")
between_error_SA_scanner <- read.csv("2_analysis_output/between_error_SA_scanner.csv")
between_error_GM_scanner <- read.csv("2_analysis_output/between_error_GM_scanner.csv")

# sites within scanners
multigroup_CFIs_CT_GE <- read.csv("2_analysis_output/multigroup_CFIs_CT_GE.csv")
multigroup_CFIs_CT_Philips <- read.csv("2_analysis_output/multigroup_CFIs_CT_Philips.csv")
multigroup_CFIs_CT_Siemens <- read.csv("2_analysis_output/multigroup_CFIs_CT_Siemens.csv")
multigroup_CFIs_SA_GE <- read.csv("2_analysis_output/multigroup_CFIs_SA_GE.csv")
multigroup_CFIs_SA_Philips <- read.csv("2_analysis_output/multigroup_CFIs_SA_Philips.csv")
multigroup_CFIs_SA_Siemens <- read.csv("2_analysis_output/multigroup_CFIs_SA_Siemens.csv")
multigroup_CFIs_GM_GE <- read.csv("2_analysis_output/multigroup_CFIs_GM_GE.csv")
multigroup_CFIs_GM_Philips <- read.csv("2_analysis_output/multigroup_CFIs_GM_Philips.csv")
multigroup_CFIs_GM_Siemens <- read.csv("2_analysis_output/multigroup_CFIs_GM_Siemens.csv")


}

if(use_sim == TRUE) {

# ICC and ICC2 results
out_CT <- read.csv("5_simulated_analyses_output/out_CT_sim.csv")
out_SA <- read.csv("5_simulated_analyses_output/out_SA_sim.csv")
out_GM <- read.csv("5_simulated_analyses_output/out_GM_sim.csv")

#between and within variance estimates (per site) results
between_error_CT <- read.csv("5_simulated_analyses_output/between_error_CT_sim.csv")
between_error_SA <- read.csv("5_simulated_analyses_output/between_error_SA_sim.csv")
between_error_GM <- read.csv("5_simulated_analyses_output/between_error_GM_sim.csv")

# LRT results from multisite
sites_LRTs_CT_tidy <- read.csv("5_simulated_analyses_output/sites_LRTs_CT_tidy_aicbic_sim.csv")
sites_LRTs_SA_tidy <- read.csv("5_simulated_analyses_output/sites_LRTs_SA_tidy_aicbic_sim.csv")
sites_LRTs_GM_tidy <- read.csv("5_simulated_analyses_output/sites_LRTs_GM_tidy_aicbic_sim.csv")

# improved LRT results and CFIS
sites_LRTs_CT_tidy_aicbic <- read.csv("5_simulated_analyses_output/sites_LRTs_CT_tidy_aicbic_sim.csv")
multigroup_CFIs_CT <- read.csv("5_simulated_analyses_output/multigroup_CFIs_CT_sim.csv")
sites_LRTs_SA_tidy_aicbic <- read.csv("5_simulated_analyses_output/sites_LRTs_SA_tidy_aicbic_sim.csv")
multigroup_CFIs_SA <- read.csv("5_simulated_analyses_output/multigroup_CFIs_SA_sim.csv")
sites_LRTs_GM_tidy_aicbic <- read.csv("5_simulated_analyses_output/sites_LRTs_GM_tidy_aicbic_sim.csv")
multigroup_CFIs_GM <- read.csv("5_simulated_analyses_output/multigroup_CFIs_GM_sim.csv")

# scanner multigroup results
multigroup_CFIs_CT_scanners <- read.csv("5_simulated_analyses_output/multigroup_CFIs_CT_scanners_sim.csv")
multigroup_CFIs_SA_scanners <- read.csv("5_simulated_analyses_output/multigroup_CFIs_SA_scanners_sim.csv")
multigroup_CFIs_GM_scanners <- read.csv("5_simulated_analyses_output/multigroup_CFIs_GM_scanners_sim.csv")

between_error_CT_scanner <- read.csv("5_simulated_analyses_output/between_error_CT_scanner_sim.csv")
between_error_SA_scanner <- read.csv("5_simulated_analyses_output/between_error_SA_scanner_sim.csv")
between_error_GM_scanner <- read.csv("5_simulated_analyses_output/between_error_GM_scanner_sim.csv")

# sites within scanners
multigroup_CFIs_CT_GE <- read.csv("5_simulated_analyses_output/multigroup_CFIs_CT_sim_GE.csv")
multigroup_CFIs_CT_Philips <- read.csv("5_simulated_analyses_output/multigroup_CFIs_CT_sim_Philips.csv")
multigroup_CFIs_CT_Siemens <- read.csv("5_simulated_analyses_output/multigroup_CFIs_CT_sim_Siemens.csv")
multigroup_CFIs_SA_GE <- read.csv("5_simulated_analyses_output/multigroup_CFIs_SA_sim_GE.csv")
multigroup_CFIs_SA_Philips <- read.csv("5_simulated_analyses_output/multigroup_CFIs_SA_sim_Philips.csv")
multigroup_CFIs_SA_Siemens <- read.csv("5_simulated_analyses_output/multigroup_CFIs_SA_sim_Siemens.csv")
multigroup_CFIs_GM_GE <- read.csv("5_simulated_analyses_output/multigroup_CFIs_GM_sim_GE.csv")
multigroup_CFIs_GM_Philips <- read.csv("5_simulated_analyses_output/multigroup_CFIs_GM_sim_Philips.csv")
multigroup_CFIs_GM_Siemens <- read.csv("5_simulated_analyses_output/multigroup_CFIs_GM_sim_Siemens.csv")
}


```


# 1. Stability estimates

# ICC results

```{r grey_summary}

# simple summary statistics

# ICC

mean(out_CT$ICC, na.rm = TRUE)
median(out_CT$ICC, na.rm = TRUE)
range(out_CT$ICC, na.rm = TRUE)

sum(out_CT$ICC < .7) / nrow(out_CT)
sum(out_CT$ICC < .75) / nrow(out_CT)


mean(out_SA$ICC, na.rm = TRUE)
median(out_SA$ICC, na.rm = TRUE)
range(out_SA$ICC, na.rm = TRUE)

mean(out_GM$ICC, na.rm = TRUE)
median(out_GM$ICC, na.rm = TRUE)
range(out_GM$ICC, na.rm = TRUE)

# ICC2

mean(out_CT$ICC2, na.rm = TRUE)
median(out_CT$ICC2, na.rm = TRUE)
range(out_CT$ICC2, na.rm = TRUE)

sum(out_CT$ICC2 < .7) / nrow(out_CT)

mean(out_SA$ICC2, na.rm = TRUE)
median(out_SA$ICC2, na.rm = TRUE)
range(out_SA$ICC2, na.rm = TRUE)

mean(out_GM$ICC2, na.rm = TRUE)
median(out_GM$ICC2, na.rm = TRUE)
range(out_GM$ICC2, na.rm = TRUE)



```

```{r Cortical_Thickness_ICCfigs}

# combine dk atlas from ggseg with Cortical Thickness estimates
comb_CT <- dk %>% 
  as_tibble() %>% 
  left_join(out_CT)

# plot ICC estimates
CT_ICC1 <- ggseg(comb_CT, atlas = dk, 
      colour = "black",
      size = .1, 
      #position = "stacked",
      mapping = aes(fill = ICC)) +
  scale_fill_continuous(limits = c(.5, 1), type = "viridis") +
  ggtitle("Cortical Thickness") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())

# plot ICC2 estimates
CT_ICC2 <- ggseg(comb_CT, atlas = dk, 
      colour = "black",
      size = .1, 
      #position = "stacked",
      mapping = aes(fill = ICC2)) +
    scale_fill_continuous(limits = c(.5, 1), type = "viridis") +
  ggtitle("Cortical Thickness") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())


```

```{r Surface_Area_ICCfigs}

# combine dk atlas from ggseg with Cortical Thickness estimates
comb_SA <- dk %>% 
  as_tibble() %>% 
  left_join(out_SA)

# plot ICC estimates
SA_ICC1 <- ggseg(comb_SA, atlas = dk, 
      colour = "black",
      size = .1, 
      #position = "stacked",
      mapping = aes(fill = ICC)) +
        scale_fill_continuous(limits = c(.5, 1), type = "viridis") +
        ggtitle("Surface Area") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())

# plot ICC2 estimates
SA_ICC2 <- ggseg(comb_SA, atlas = dk, 
      colour = "black",
      size = .1, 
      #position = "stacked",
      mapping = aes(fill = ICC2)) +
    scale_fill_continuous(limits = c(.5, 1), type = "viridis") +
  ggtitle("Surface Area") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())



```

```{r Grey_Matter_Volume__ICCfigs}

# combine dk atlas from ggseg with Cortical Thickness estimates
comb_GM <- dk %>% 
  as_tibble() %>% 
  left_join(out_GM)

# plot ICC estimates
GM_ICC1 <- ggseg(comb_GM, atlas = dk, 
      colour = "black",
      size = .1, 
      #position = "stacked",
      mapping = aes(fill = ICC)) +
    scale_fill_continuous(limits = c(.5, 1), type = "viridis") +
  ggtitle("Grey Matter Volume")

# plot ICC2 estimates
GM_ICC2 <- ggseg(comb_GM, atlas = dk, 
      colour = "black",
      size = .1, 
      #position = "stacked",
      mapping = aes(fill = ICC2)) +
    scale_fill_continuous(limits = c(.5, 1), type = "viridis") +
  ggtitle("Grey Matter Volume")

```

## ICC

```{r grey_figures_ICC}

# plot and save all ICC figures
if(use_sim == FALSE) {
Cairo(file = "6_figures/Figure2.png",
      type = "png",
      units="in", 
      width=6, 
      height=5, 
      pointsize=12, 
      dpi=600)

Figure2 <- CT_ICC1 / SA_ICC1 / GM_ICC1 + plot_layout(guides = 'collect') & theme(legend.position = "bottom",
                  legend.key.width=unit(1,"cm"), legend.key.height = unit(.5,"cm"))

print(Figure2)

dev.off()
}

if(use_sim == TRUE) {
Cairo(file = "9_supplement_simulated/Figure2_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=5, 
      pointsize=12, 
      dpi=600)

Figure2_sim <- CT_ICC1 / SA_ICC1 / GM_ICC1 + plot_layout(guides = 'collect') & theme(legend.position = "bottom",
                  legend.key.width=unit(1,"cm"), legend.key.height = unit(.5,"cm"))

print(Figure2_sim)

dev.off()
}


```

## ICC2

```{r grey_figures_ICC2}

# plot and save all ICC2 figures
if(use_sim == FALSE){
Cairo(file = "6_figures/Figure3.png",
      type = "png",
      units="in", 
      width=6, 
      height=5, 
      pointsize=12, 
      dpi=600)

Figure_3 <- CT_ICC2 / SA_ICC2 / GM_ICC2 + plot_layout(guides = 'collect') & theme(legend.position = "bottom",
                  legend.key.width=unit(1,"cm"), legend.key.height = unit(.5,"cm"))

print(Figure_3)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure3_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=5, 
      pointsize=12, 
      dpi=600)

Figure_3_sim <- CT_ICC2 / SA_ICC2 / GM_ICC2 + plot_layout(guides = 'collect') & theme(legend.position = "bottom",
                  legend.key.width=unit(1,"cm"), legend.key.height = unit(.5,"cm"))

print(Figure_3_sim)

dev.off()
}

```  


# 2. Examining sources of longitudinal (in)stability

# Proportions of between-subejct and error variances, depending on site or ROI split

```{r all_between_error_CT_variance_proportions}
# of interest to compare the spread of estimates

# proportion of between subjects to error variance, by ROI
between_error_CT %>%
  group_by(ROI) %>%
  summarise(mt = median(time_var),
            me = median(error_var)) %>%
  ungroup() %>%
  summarise(vart = var(mt),
            vare = var(me)) %>%
  mutate(prop = vart / vare)

# proportion of between subjects to error variance, by site
between_error_CT %>%
  group_by(site) %>%
  summarise(mt = median(time_var),
            me = median(error_var)) %>%
  ungroup() %>%
  summarise(vart = var(mt),
            vare = var(me)) %>%
  mutate(prop = vart / vare,
         prop2 = vare / vart)

```

```{r all_between_error_SA_variance_proportions}
# of interest to compare the spread of estimates

# proportion of between subjects to error variance, by ROI
between_error_SA %>%
  group_by(ROI) %>%
  summarise(mt = median(time_var),
            me = median(error_var)) %>%
  ungroup() %>%
  summarise(vart = var(mt),
            vare = var(me)) %>%
  mutate(prop = vart / vare)

# proportion of between subjects to error variance, by site
between_error_SA %>%
  group_by(site) %>%
  summarise(mt = median(time_var),
            me = median(error_var)) %>%
  ungroup() %>%
  summarise(vart = var(mt),
            vare = var(me)) %>%
  mutate(prop = vart / vare,
         prop2 = vare / vart)

```

```{r all_between_error_GM_variance_proportions}
# of interest to compare the spread of estimates

# proportion of between subjects to error variance, by ROI
between_error_GM %>%
  group_by(ROI) %>%
  summarise(mt = median(time_var),
            me = median(error_var)) %>%
  ungroup() %>%
  summarise(vart = var(mt),
            vare = var(me)) %>%
  mutate(prop = vart / vare)

# proportion of between subjects to error variance, by site
between_error_GM %>%
  group_by(site) %>%
  summarise(mt = median(time_var),
            me = median(error_var)) %>%
  ungroup() %>%
  summarise(vart = var(mt),
            vare = var(me)) %>%
  mutate(prop = vart / vare,
         prop2 = vare / vart)

```
  


## decomposing variance estimates

# Cortical Thickness (included in main paper)

```{r betweenanderrormain_CT_regions}

by_ROI_CT_box_error <- between_error_CT %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.title.x = element_text(size = 14)) +
  ylab("Error variance")

by_ROI_CT_box_time <- between_error_CT %>%
    filter(grepl("rh_", ROI)) %>%
    mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14)) +
  ylab("Between-subjects variance")

by_ROI_ICC_CT <- between_error_CT %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(ROI) %>%
  summarise(m_ICC = median(ICC),
            m_time = median(time_var)) %>%
  ggplot(aes(x = reorder(ROI, -m_time),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.title.x = element_text(size = 14)) +
  ylab("ICC")

if(use_sim == FALSE){
Cairo(file = "6_figures/Figure4.png",
      type = "png",
      units="in", 
      width=8, 
      height=8, 
      pointsize=12, 
      dpi=600)

Figure_4 <- by_ROI_CT_box_time + by_ROI_CT_box_error + by_ROI_ICC_CT + plot_layout(widths = c(4,4,1))

print(Figure_4)

dev.off()
}

if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure4_sim.png",
      type = "png",
      units="in", 
      width=8, 
      height=8, 
      pointsize=12, 
      dpi=600)

Figure_4_sim <- by_ROI_CT_box_time + by_ROI_CT_box_error + by_ROI_ICC_CT + plot_layout(widths = c(4,4,1))

print(Figure_4_sim)

dev.off()
}


```

```{r betweenanderrormain_CT_sites}

between_error_CT %>%
  group_by(ROI, site) %>%
  summarise(median_t = median(time_var),
            median_e = median(error_var)) %>%
  ungroup() %>%
  summarise(median_t2 = median(median_t),
            quantilet25 = quantile(median_t, .1),
            quantilet75 = quantile(median_t, .9),

            median_e2 = median(median_e),
            quantilee25 = quantile(median_e, .1),
            quantilee75 = quantile(median_e, .9))


#################

by_site_CT_box_error <- between_error_CT %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50")) +
  ylab("Error variance")


by_site_CT_box_true <- between_error_CT %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12)) +
  ylab("Between-subjects variance")


by_site_ICC_CT <- between_error_CT %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(site) %>%
  summarise(m_ICC = median(ICC),
            m_error = median(error_var)) %>%
  ggplot(aes(x = reorder(site, -m_error),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank()) +
  ylab("ICC")

if(use_sim == FALSE){
Cairo(file = "6_figures/Figure5.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure_5 <- by_site_CT_box_true + by_site_CT_box_error + by_site_ICC_CT + plot_layout(widths = c(4,4,1))

print(Figure_5)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure5_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure_5_sim <- by_site_CT_box_true + by_site_CT_box_error + by_site_ICC_CT + plot_layout(widths = c(4,4,1))

print(Figure_5_sim)

dev.off()
}

```

## look at rank stability (Table 1) - Figures not included in paper

```{r rank_order_stability_CT, eval=FALSE}

#### by ROI
between_error_CT %>%
  select(site, ROI, ICC) %>%
  pivot_wider(values_from = ICC,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_icc_CT <- between_error_CT %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = ICC, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

# roi between sub
between_error_CT %>%
  select(site, ROI, time_var) %>%
  pivot_wider(values_from = time_var,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_between_CT <- between_error_CT %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = time_var, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  ylab("between-subjects \nvariance")

# roi error
between_error_CT %>%
  select(site, ROI, error_var) %>%
  pivot_wider(values_from = error_var,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_err_CT <- between_error_CT %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = error_var, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  xlab("site") +
  ylab("error \nvariance")

roi_icc_CT / roi_between_CT / roi_err_CT

#### by site
between_error_CT %>%
  select(site, ROI, ICC) %>%
  pivot_wider(values_from = ICC,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_icc_CT <- between_error_CT %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = ICC, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

# site between sub
between_error_CT %>%
  select(site, ROI, time_var) %>%
  pivot_wider(values_from = time_var,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_between_CT <- between_error_CT %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = time_var, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  ylab("between-subjects \nvariance")

# site roi
between_error_CT %>%
  select(site, ROI, error_var) %>%
  pivot_wider(values_from = error_var,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_error_CT <- between_error_CT %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = error_var, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.text.x = element_blank()) +
  xlab("region") +
  ylab("error \nvariance")

site_icc_CT / site_between_CT / site_error_CT

```

# Surface Area (for supplement)

```{r betweenanderrormain_SA_regions}

by_ROI_SA_box_error <- between_error_SA %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.title.x = element_text(size = 14)) +
  ylab("Error variance")

by_ROI_SA_box_time <- between_error_SA %>%
    filter(grepl("rh_", ROI)) %>%
    mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14)) +
  ylab("Between-subjects variance")

by_ROI_ICC_SA <- between_error_SA %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(ROI) %>%
  summarise(m_ICC = median(ICC),
            m_time = median(time_var)) %>%
  ggplot(aes(x = reorder(ROI, -m_time),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.title.x = element_text(size = 14)) +
  ylab("ICC")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure4_SA.png",
      type = "png",
      units="in", 
      width=8, 
      height=8, 
      pointsize=12, 
      dpi=600)

Figure4_SA <- by_ROI_SA_box_time + by_ROI_SA_box_error + by_ROI_ICC_SA + plot_layout(widths = c(4,4,1))

print(Figure4_SA)

dev.off()
}

if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure4_SA_sim.png",
      type = "png",
      units="in", 
      width=8, 
      height=8, 
      pointsize=12, 
      dpi=600)

Figure4_SA_sim <- by_ROI_SA_box_time + by_ROI_SA_box_error + by_ROI_ICC_SA + plot_layout(widths = c(4,4,1))

print(Figure4_SA_sim)

dev.off()
}

```

```{r betweenanderrormain_SA_sites}

between_error_SA %>%
  group_by(ROI, site) %>%
  summarise(median_t = median(time_var),
            median_e = median(error_var)) %>%
  ungroup() %>%
  summarise(median_t2 = median(median_t),
            quantilet25 = quantile(median_t, .1),
            quantilet75 = quantile(median_t, .9),

            median_e2 = median(median_e),
            quantilee25 = quantile(median_e, .1),
            quantilee75 = quantile(median_e, .9))


#################

by_site_SA_box_error <- between_error_SA %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50")) +
  ylab("Error variance")


by_site_SA_box_true <- between_error_SA %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12)) +
  ylab("Between-subjects variance")


by_site_ICC_SA <- between_error_SA %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(site) %>%
  summarise(m_ICC = median(ICC),
            m_error = median(error_var)) %>%
  ggplot(aes(x = reorder(site, -m_error),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank()) +
  ylab("ICC")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure5_SA.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure5_SA <- by_site_SA_box_true + by_site_SA_box_error + by_site_ICC_SA  + plot_layout(widths = c(4,4,1))

print(Figure5_SA)

dev.off()
}

if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure5_SA_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure5_SA_sim <- by_site_SA_box_true + by_site_SA_box_error + by_site_ICC_SA  + plot_layout(widths = c(4,4,1))

print(Figure5_SA_sim)

dev.off()
}
```

## look at rank stability

```{r rank_order_stability_SA, eval=FALSE}

#### by ROI
between_error_SA %>%
  select(site, ROI, ICC) %>%
  pivot_wider(values_from = ICC,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_icc_SA <- between_error_SA %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = ICC, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

# roi between sub
between_error_SA %>%
  select(site, ROI, time_var) %>%
  pivot_wider(values_from = time_var,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_between_SA <- between_error_SA %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = time_var, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  ylab("between-subjects \nvariance")

# roi error
between_error_SA %>%
  select(site, ROI, error_var) %>%
  pivot_wider(values_from = error_var,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_err_SA <- between_error_CT %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = error_var, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  xlab("site") +
  ylab("error \nvariance")

roi_icc_SA / roi_between_SA / roi_err_SA

#### by site
between_error_SA %>%
  select(site, ROI, ICC) %>%
  pivot_wider(values_from = ICC,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_icc_SA <- between_error_SA %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = ICC, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

# site between sub
between_error_SA %>%
  select(site, ROI, time_var) %>%
  pivot_wider(values_from = time_var,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_between_SA <- between_error_SA %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = time_var, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  ylab("between-subjects \nvariance")

# site roi
between_error_SA %>%
  select(site, ROI, error_var) %>%
  pivot_wider(values_from = error_var,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_error_SA <- between_error_SA %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = error_var, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.text.x = element_blank()) +
  xlab("region") +
  ylab("error \nvariance")

site_icc_SA / site_between_SA / site_error_SA

```

# Grey matter volume (for supplement)

```{r betweenanderrormain_GM_regions}

by_ROI_GM_box_error <- between_error_GM %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.title.x = element_text(size = 14)) +
  ylab("Error variance")

by_ROI_GM_box_time <- between_error_GM %>%
    filter(grepl("rh_", ROI)) %>%
    mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14)) +
  ylab("Between-subjects variance")

by_ROI_ICC_GM <- between_error_GM %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(ROI) %>%
  summarise(m_ICC = median(ICC),
            m_time = median(time_var)) %>%
  ggplot(aes(x = reorder(ROI, -m_time),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.title.x = element_text(size = 14)) +
  ylab("ICC")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure4_GM.png",
      type = "png",
      units="in", 
      width=8, 
      height=8, 
      pointsize=12, 
      dpi=600)

Figure4_GM <- by_ROI_GM_box_time + by_ROI_GM_box_error + by_ROI_ICC_GM + plot_layout(widths = c(4,4,1))

print(Figure4_GM)

dev.off()
}

if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure4_GM_sim.png",
      type = "png",
      units="in", 
      width=8, 
      height=8, 
      pointsize=12, 
      dpi=600)

Figure4_GM_sim <- by_ROI_GM_box_time + by_ROI_GM_box_error + by_ROI_ICC_GM + plot_layout(widths = c(4,4,1))

print(Figure4_GM_sim)

dev.off()
}

```

```{r betweenanderrormain_GM_sites}

between_error_GM %>%
  group_by(ROI, site) %>%
  summarise(median_t = median(time_var),
            median_e = median(error_var)) %>%
  ungroup() %>%
  summarise(median_t2 = median(median_t),
            quantilet25 = quantile(median_t, .1),
            quantilet75 = quantile(median_t, .9),

            median_e2 = median(median_e),
            quantilee25 = quantile(median_e, .1),
            quantilee75 = quantile(median_e, .9))


#################

by_site_GM_box_error <- between_error_GM %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50")) +
  ylab("Error variance")


by_site_GM_box_true <- between_error_GM %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12)) +
  ylab("Between-subjects variance")


by_site_ICC_GM <- between_error_GM %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(site) %>%
  summarise(m_ICC = median(ICC),
            m_error = median(error_var)) %>%
  ggplot(aes(x = reorder(site, -m_error),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank()) +
  ylab("ICC")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure5_GM.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure5_GM <- by_site_SA_box_true + by_site_SA_box_error + by_site_ICC_SA  + plot_layout(widths = c(4,4,1))

print(Figure5_GM)

dev.off()
}

if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure5_GM_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure5_GM_sim <- by_site_SA_box_true + by_site_SA_box_error + by_site_ICC_SA  + plot_layout(widths = c(4,4,1))

print(Figure5_GM_sim)

dev.off()
}
```

## look at rank stability

```{r rank_order_stability_GM, eval=FALSE}

#### by ROI
between_error_GM %>%
  select(site, ROI, ICC) %>%
  pivot_wider(values_from = ICC,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_icc_GM <- between_error_GM %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = ICC, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

# roi between sub
between_error_GM %>%
  select(site, ROI, time_var) %>%
  pivot_wider(values_from = time_var,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_between_GM <- between_error_GM %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = time_var, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  ylab("between-subjects \nvariance")

# roi error
between_error_GM %>%
  select(site, ROI, error_var) %>%
  pivot_wider(values_from = error_var,
              names_from = site) %>%
  select(-ROI) %>%
  as.data.frame() %>%
  psych::ICC()

roi_err_GM <- between_error_GM %>%
  ggplot(aes(x = reorder(site, ICC, FUN = median), y = error_var, group = ROI, colour = ROI)) +
  geom_line() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  xlab("site") +
  ylab("error \nvariance")

roi_icc_GM / roi_between_GM / roi_err_GM

#### by site
between_error_GM %>%
  select(site, ROI, ICC) %>%
  pivot_wider(values_from = ICC,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_icc_GM <- between_error_GM %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = ICC, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

# site between sub
between_error_GM %>%
  select(site, ROI, time_var) %>%
  pivot_wider(values_from = time_var,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_between_GM <- between_error_GM %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = time_var, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  ylab("between-subjects \nvariance")

# site roi
between_error_GM %>%
  select(site, ROI, error_var) %>%
  pivot_wider(values_from = error_var,
              names_from = ROI) %>%
  select(-site) %>%
  as.data.frame() %>%
  psych::ICC()

site_error_GM <- between_error_GM %>%
  ggplot(aes(x = reorder(ROI, ICC, FUN = median), y = error_var, group = site, colour = site)) +
  geom_line() +
  theme(legend.position = "none",
        axis.text.x = element_blank()) +
  xlab("region") +
  ylab("error \nvariance")

site_icc_GM / site_between_GM / site_error_GM

```


# multigroup models

Chi squared differences (for supplement)

```{r CT_multigroup_Chi}
minLRT_diff_CT <- min(sites_LRTs_CT_tidy$Chisq.diff, na.rm = TRUE)
maxLRT_diff_CT <- max(sites_LRTs_CT_tidy$Chisq.diff, na.rm = TRUE)

CT_LRT_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_CT, maxLRT_diff_CT),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

CT_LRT_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_CT, maxLRT_diff_CT),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

CT_LRT_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_CT, maxLRT_diff_CT),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

CT_LRT_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_CT, maxLRT_diff_CT),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

CT_LRT_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_CT, maxLRT_diff_CT),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

if(use_sim == FALSE) {
Cairo(file = "8_supplement/Figure7_CT_ChisquaredLRT.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_CT_ChisquaredLRT <- CT_LRT_ggseg_errcon_v_con / CT_LRT_ggseg_uncon_v_errcon / CT_LRT_ggseg_timecon_v_con / CT_LRT_ggseg_uncon_v_timecon / CT_LRT_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_CT_ChisquaredLRT)

dev.off()
}

if(use_sim == TRUE) {
Cairo(file = "9_supplement_simulated/Figure7_CT_ChisquaredLRT_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_CT_ChisquaredLRT_sim <- CT_LRT_ggseg_errcon_v_con / CT_LRT_ggseg_uncon_v_errcon / CT_LRT_ggseg_timecon_v_con / CT_LRT_ggseg_uncon_v_timecon / CT_LRT_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_CT_ChisquaredLRT_sim)

dev.off()
}
```

```{r SA_multigroup_Chi}
minLRT_diff_SA <- min(sites_LRTs_SA_tidy$Chisq.diff, na.rm = TRUE)
maxLRT_diff_SA <- max(sites_LRTs_SA_tidy$Chisq.diff, na.rm = TRUE)

SA_LRT_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_SA, maxLRT_diff_SA),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

SA_LRT_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_SA, maxLRT_diff_SA),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

SA_LRT_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_SA, maxLRT_diff_SA),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

SA_LRT_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_SA, maxLRT_diff_SA),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

SA_LRT_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_SA, maxLRT_diff_SA),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_SA_ChisquaredLRT.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_ChisquaredLRT <- SA_LRT_ggseg_errcon_v_con / SA_LRT_ggseg_uncon_v_errcon / SA_LRT_ggseg_timecon_v_con / SA_LRT_ggseg_uncon_v_timecon / SA_LRT_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_SA_ChisquaredLRT)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_SA_ChisquaredLRT_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_ChisquaredLRT_sim <- SA_LRT_ggseg_errcon_v_con / SA_LRT_ggseg_uncon_v_errcon / SA_LRT_ggseg_timecon_v_con / SA_LRT_ggseg_uncon_v_timecon / SA_LRT_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_SA_ChisquaredLRT_sim)

dev.off()
}
```

```{r GM_multigroup_Chi}
minLRT_diff_GM <- min(sites_LRTs_GM_tidy$Chisq.diff, na.rm = TRUE)
maxLRT_diff_GM <- max(sites_LRTs_GM_tidy$Chisq.diff, na.rm = TRUE)

GM_LRT_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_GM, maxLRT_diff_GM),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

GM_LRT_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_GM, maxLRT_diff_GM),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

GM_LRT_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_GM, maxLRT_diff_GM),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

GM_LRT_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_GM, maxLRT_diff_GM),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

GM_LRT_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = Chisq.diff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minLRT_diff_GM, maxLRT_diff_GM),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_GM_ChisquaredLRT.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_ChisquaredLRT <- GM_LRT_ggseg_errcon_v_con / GM_LRT_ggseg_uncon_v_errcon / GM_LRT_ggseg_timecon_v_con / GM_LRT_ggseg_uncon_v_timecon / GM_LRT_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_GM_ChisquaredLRT)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_GM_ChisquaredLRT_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_ChisquaredLRT_sim <- GM_LRT_ggseg_errcon_v_con / GM_LRT_ggseg_uncon_v_errcon / GM_LRT_ggseg_timecon_v_con / GM_LRT_ggseg_uncon_v_timecon / GM_LRT_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_GM_ChisquaredLRT_sim)

dev.off()
}
```

delta AIC (for supplement)

```{r CT_multigroup_AIC}
minAIC_diff_CT <- min(sites_LRTs_CT_tidy_aicbic$AICdiff, na.rm = TRUE)
maxAIC_diff_CT <- max(sites_LRTs_CT_tidy_aicbic$AICdiff, na.rm = TRUE)

CT_AIC_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_CT, maxAIC_diff_CT),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying (df = 20)")

CT_AIC_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_CT, maxAIC_diff_CT),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained (df = 20)")

CT_AIC_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_CT, maxAIC_diff_CT),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying (df = 20)")

CT_AIC_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_CT, maxAIC_diff_CT),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained (df = 20)")

CT_AIC_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_CT, maxAIC_diff_CT),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained (df = 40)")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_CT_deltaAIC.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_CT_deltaAIC <- CT_AIC_ggseg_errcon_v_con / CT_AIC_ggseg_uncon_v_errcon / CT_AIC_ggseg_timecon_v_con / CT_AIC_ggseg_uncon_v_timecon / CT_AIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_CT_deltaAIC)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_CT_deltaAIC_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_CT_deltaAIC_sim <- CT_AIC_ggseg_errcon_v_con / CT_AIC_ggseg_uncon_v_errcon / CT_AIC_ggseg_timecon_v_con / CT_AIC_ggseg_uncon_v_timecon / CT_AIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_CT_deltaAIC_sim)

dev.off()
}
```

```{r SA_multigroup_AIC}
minAIC_diff_SA <- min(sites_LRTs_SA_tidy_aicbic$AICdiff, na.rm = TRUE)
maxAIC_diff_SA <- max(sites_LRTs_SA_tidy_aicbic$AICdiff, na.rm = TRUE)

SA_AIC_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_SA, maxAIC_diff_SA),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying (df = 20)")

SA_AIC_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_SA, maxAIC_diff_SA),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained (df = 20)")

SA_AIC_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_SA, maxAIC_diff_SA),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying (df = 20)")

SA_AIC_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_SA, maxAIC_diff_SA),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained (df = 20)")

SA_AIC_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_SA, maxAIC_diff_SA),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained (df = 40)")


if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_SA_deltaAIC.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_deltaAIC <- SA_AIC_ggseg_errcon_v_con / SA_AIC_ggseg_uncon_v_errcon / SA_AIC_ggseg_timecon_v_con / SA_AIC_ggseg_uncon_v_timecon / SA_AIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_SA_deltaAIC)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_SA_deltaAIC_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_deltaAIC_sim <- SA_AIC_ggseg_errcon_v_con / SA_AIC_ggseg_uncon_v_errcon / SA_AIC_ggseg_timecon_v_con / SA_AIC_ggseg_uncon_v_timecon / SA_AIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_SA_deltaAIC_sim)

dev.off()
}
```

```{r GM_multigroup_AIC}
minAIC_diff_GM <- min(sites_LRTs_GM_tidy_aicbic$AICdiff, na.rm = TRUE)
maxAIC_diff_GM <- max(sites_LRTs_GM_tidy_aicbic$AICdiff, na.rm = TRUE)

GM_AIC_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_GM, maxAIC_diff_GM),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying (df = 20)")

GM_AIC_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_GM, maxAIC_diff_GM),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained (df = 20)")

GM_AIC_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_GM, maxAIC_diff_GM),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying (df = 20)")

GM_AIC_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_GM, maxAIC_diff_GM),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained (df = 20)")

GM_AIC_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = AICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minAIC_diff_GM, maxAIC_diff_GM),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained (df = 40)")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_GM_deltaAIC.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_deltaAIC <- GM_AIC_ggseg_errcon_v_con / GM_AIC_ggseg_uncon_v_errcon / GM_AIC_ggseg_timecon_v_con / GM_AIC_ggseg_uncon_v_timecon / GM_AIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_GM_deltaAIC)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_GM_deltaAIC_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_deltaAIC_sim <- GM_AIC_ggseg_errcon_v_con / GM_AIC_ggseg_uncon_v_errcon / GM_AIC_ggseg_timecon_v_con / GM_AIC_ggseg_uncon_v_timecon / GM_AIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_GM_deltaAIC_sim)

dev.off()
}
```


delta BIC (for supplement)

```{r CT_multigroup_BIC}
minBIC_diff_CT <- min(sites_LRTs_CT_tidy_aicbic$BICdiff, na.rm = TRUE)
maxBIC_diff_CT <- max(sites_LRTs_CT_tidy_aicbic$BICdiff, na.rm = TRUE)

CT_BIC_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_CT, maxBIC_diff_CT),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying (df = 20)")

CT_BIC_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_CT, maxBIC_diff_CT),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained (df = 20)")

CT_BIC_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_CT, maxBIC_diff_CT),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying (df = 20)")

CT_BIC_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_CT, maxBIC_diff_CT),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained (df = 20)")

CT_BIC_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_CT_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_CT, maxBIC_diff_CT),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained (df = 40)")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_CT_deltaBIC.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_CT_deltaBIC <- CT_BIC_ggseg_errcon_v_con / CT_BIC_ggseg_uncon_v_errcon / CT_BIC_ggseg_timecon_v_con / CT_BIC_ggseg_uncon_v_timecon / CT_BIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_CT_deltaBIC)

dev.off()
}

if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_CT_deltaBIC_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_CT_deltaBIC_sim <- CT_BIC_ggseg_errcon_v_con / CT_BIC_ggseg_uncon_v_errcon / CT_BIC_ggseg_timecon_v_con / CT_BIC_ggseg_uncon_v_timecon / CT_BIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_CT_deltaBIC_sim)

dev.off()
}
```

```{r SA_multigroup_BIC}
minBIC_diff_SA <- min(sites_LRTs_SA_tidy_aicbic$BICdiff, na.rm = TRUE)
maxBIC_diff_SA <- max(sites_LRTs_SA_tidy_aicbic$BICdiff, na.rm = TRUE)

SA_BIC_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_SA, maxBIC_diff_SA),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying (df = 20)")

SA_BIC_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_SA, maxBIC_diff_SA),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained (df = 20)")

SA_BIC_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_SA, maxBIC_diff_SA),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying (df = 20)")

SA_BIC_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_SA, maxBIC_diff_SA),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained (df = 20)")

SA_BIC_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_SA_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_SA, maxBIC_diff_SA),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained (df = 40)")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_SA_deltaBIC.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_deltaBIC <- SA_BIC_ggseg_errcon_v_con / SA_BIC_ggseg_uncon_v_errcon / SA_BIC_ggseg_timecon_v_con / SA_BIC_ggseg_uncon_v_timecon / SA_BIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_SA_deltaBIC)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_SA_deltaBIC_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_deltaBIC_sim <- SA_BIC_ggseg_errcon_v_con / SA_BIC_ggseg_uncon_v_errcon / SA_BIC_ggseg_timecon_v_con / SA_BIC_ggseg_uncon_v_timecon / SA_BIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_SA_deltaBIC_sim)

dev.off()
}
```

```{r GM_multigroup_BIC}
minBIC_diff_GM <- min(sites_LRTs_GM_tidy_aicbic$BICdiff, na.rm = TRUE)
maxBIC_diff_GM <- max(sites_LRTs_GM_tidy_aicbic$BICdiff, na.rm = TRUE)

GM_BIC_ggseg_errcon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "errcon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_GM, maxBIC_diff_GM),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying (df = 20)")

GM_BIC_ggseg_uncon_v_errcon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_errcon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_GM, maxBIC_diff_GM),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained (df = 20)")

GM_BIC_ggseg_timecon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "timecon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
  theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_GM, maxBIC_diff_GM),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying (df = 20)")

GM_BIC_ggseg_uncon_v_timecon <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_timecon") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_GM, maxBIC_diff_GM),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained (df = 20)")

GM_BIC_ggseg_uncon_v_con <- dk %>% 
  as_tibble() %>% 
  left_join(sites_LRTs_GM_tidy_aicbic, by = c("label" = "ROI")) %>%
  filter(comparison == "uncon_v_con") %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = BICdiff)) +
    theme_void() +
  scale_fill_continuous(limits = c(minBIC_diff_GM, maxBIC_diff_GM),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained (df = 40)")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_GM_deltaBIC.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_deltaBIC <- GM_BIC_ggseg_errcon_v_con / GM_BIC_ggseg_uncon_v_errcon / GM_BIC_ggseg_timecon_v_con / GM_BIC_ggseg_uncon_v_timecon / GM_BIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_GM_deltaBIC)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_GM_deltaBIC_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_deltaBIC_sim <- GM_BIC_ggseg_errcon_v_con / GM_BIC_ggseg_uncon_v_errcon / GM_BIC_ggseg_timecon_v_con / GM_BIC_ggseg_uncon_v_timecon / GM_BIC_ggseg_uncon_v_con + plot_layout(guides = "collect") & theme(legend.position = "right", legend.key.height = unit(1, "cm"))

print(Figure7_GM_deltaBIC_sim)

dev.off()
}
```


delta CFI (CT in main paper; SA and GM in supplement)

```{r multigroup_CFIs_CT}

multigroup_CFIs_CT <- multigroup_CFIs_CT %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_CT <- multigroup_CFIs_CT %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_CT <- multigroup_CFIs_CT %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_CT %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_CT %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_CT <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT, max_deltaCFI_CT),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_CT <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT, max_deltaCFI_CT),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_CT <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT, max_deltaCFI_CT),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_CT <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT, max_deltaCFI_CT),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_CT <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT, max_deltaCFI_CT),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

if(use_sim == FALSE){
Cairo(file = "6_figures/Figure7.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7 <- deltaCFI_errcon_v_con_CT / deltaCFI_uncon_v_errcon_CT / deltaCFI_timecon_v_con_CT / deltaCFI_uncon_v_timecon_CT / deltaCFI_uncon_v_con_CT + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_sim <- deltaCFI_errcon_v_con_CT / deltaCFI_uncon_v_errcon_CT / deltaCFI_timecon_v_con_CT / deltaCFI_uncon_v_timecon_CT / deltaCFI_uncon_v_con_CT + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_sim)

dev.off()
}
```

```{r multigroup_CFIs_SA}

multigroup_CFIs_SA <- multigroup_CFIs_SA %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_SA <- multigroup_CFIs_SA %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_SA <- multigroup_CFIs_SA %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_SA %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_SA %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_SA <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA, max_deltaCFI_SA),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_SA <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA, max_deltaCFI_SA),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_SA <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA, max_deltaCFI_SA),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_SA <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA, max_deltaCFI_SA),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_SA <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA, max_deltaCFI_SA),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")


if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_SA_deltaCFI.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_deltaCFI <- deltaCFI_errcon_v_con_SA / deltaCFI_uncon_v_errcon_SA / deltaCFI_timecon_v_con_SA / deltaCFI_uncon_v_timecon_SA / deltaCFI_uncon_v_con_SA + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_SA_deltaCFI)

dev.off()
}


if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_SA_deltaCFI_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_SA_deltaCFI_sim <- deltaCFI_errcon_v_con_SA / deltaCFI_uncon_v_errcon_SA / deltaCFI_timecon_v_con_SA / deltaCFI_uncon_v_timecon_SA / deltaCFI_uncon_v_con_SA + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_SA_deltaCFI_sim)

dev.off()
}

```

```{r multigroup_CFIs_GM}

multigroup_CFIs_GM <- multigroup_CFIs_GM %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_GM <- multigroup_CFIs_GM %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_GM <- multigroup_CFIs_GM %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_GM %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_GM %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_GM <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM, max_deltaCFI_GM),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_GM <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM, max_deltaCFI_GM),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_GM <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM, max_deltaCFI_GM),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_GM <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM, max_deltaCFI_GM),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_GM <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM, max_deltaCFI_GM),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

if(use_sim == FALSE){
Cairo(file = "8_supplement/Figure7_GM_deltaCFI.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_deltaCFI <- deltaCFI_errcon_v_con_GM / deltaCFI_uncon_v_errcon_GM / deltaCFI_timecon_v_con_GM / deltaCFI_uncon_v_timecon_GM / deltaCFI_uncon_v_con_GM + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_GM_deltaCFI)

dev.off()
}

if(use_sim == TRUE){
Cairo(file = "9_supplement_simulated/Figure7_GM_deltaCFI_sim.png",
      type = "png",
      units="in", 
      width=6, 
      height=6, 
      pointsize=12, 
      dpi=600)

Figure7_GM_deltaCFI_sim <- deltaCFI_errcon_v_con_GM / deltaCFI_uncon_v_errcon_GM / deltaCFI_timecon_v_con_GM / deltaCFI_uncon_v_timecon_GM / deltaCFI_uncon_v_con_GM + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_GM_deltaCFI_sim)

dev.off()
}
```



# by scanners - CT

```{r multigroup_CFIs_CT_scanners}
#multigroup_CFIs_CT_scanners <- read.csv("2_analysis_output/multigroup_CFIs_CT_scanners.csv")

multigroup_CFIs_CT_scanners <- multigroup_CFIs_CT_scanners %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_CT_scanners <- multigroup_CFIs_CT_scanners %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_CT_scanners <- multigroup_CFIs_CT_scanners %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_CT_scanners %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_CT_scanners %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_CT_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_scanners, max_deltaCFI_CT_scanners),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_CT_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_scanners, max_deltaCFI_CT_scanners),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_CT_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_scanners, max_deltaCFI_CT_scanners),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_CT_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_scanners, max_deltaCFI_CT_scanners),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_CT_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_scanners, max_deltaCFI_CT_scanners),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_CT_scanners.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_scanners <- deltaCFI_errcon_v_con_CT_scanners / deltaCFI_uncon_v_errcon_CT_scanners / deltaCFI_timecon_v_con_CT_scanners / deltaCFI_uncon_v_timecon_CT_scanners / deltaCFI_uncon_v_con_CT_scanners + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_scanners)

 dev.off()
 }


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_CT_scanners_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_scanners_sim <- deltaCFI_errcon_v_con_CT_scanners / deltaCFI_uncon_v_errcon_CT_scanners / deltaCFI_timecon_v_con_CT_scanners / deltaCFI_uncon_v_timecon_CT_scanners / deltaCFI_uncon_v_con_CT_scanners + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

 
 print(Figure7_scanners_sim)
 
 dev.off()
 }

```

```{r betweenanderrormain_CT_regions_scanners}

by_ROI_CT_box_error_scanner <- between_error_CT_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.title.x = element_text(size = 14)) +
  ylab("Error variance")

by_ROI_CT_box_time_scanner <- between_error_CT_scanner %>%
    filter(grepl("rh_", ROI)) %>%
    mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14)) +
  ylab("Between-subjects variance")

by_ROI_ICC_CT_scanner <- between_error_CT_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(ROI) %>%
  summarise(m_ICC = median(ICC),
            m_time = median(time_var)) %>%
  ggplot(aes(x = reorder(ROI, -m_time),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.title.x = element_text(size = 14)) +
  ylab("ICC")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure4_CT_scanners.png",
       type = "png",
       units="in", 
       width=8, 
       height=8, 
       pointsize=12, 
       dpi=600)

Figure_4_scanner <- by_ROI_CT_box_time_scanner + by_ROI_CT_box_error_scanner + by_ROI_ICC_CT_scanner + plot_layout(widths = c(4,4,1))

print(Figure_4_scanner)

 dev.off()
 }
 
 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure4_CT_scanner_sim.png",
       type = "png",
       units="in", 
       width=8, 
       height=8, 
       pointsize=12, 
       dpi=600)
 
Figure_4_scanner_sim <- by_ROI_CT_box_time_scanner + by_ROI_CT_box_error_scanner + by_ROI_ICC_CT_scanner + plot_layout(widths = c(4,4,1))

print(Figure_4_scanner_sim)
 
 dev.off()
 }


```

```{r betweenanderrormain_CT_sites_scanners}

between_error_CT_scanner %>%
  group_by(ROI, site) %>%
  summarise(median_t = median(time_var),
            median_e = median(error_var)) %>%
  ungroup() %>%
  summarise(median_t2 = median(median_t),
            quantilet25 = quantile(median_t, .1),
            quantilet75 = quantile(median_t, .9),

            median_e2 = median(median_e),
            quantilee25 = quantile(median_e, .1),
            quantilee75 = quantile(median_e, .9))


#################

by_site_CT_box_error_scanner <- between_error_CT_scanner %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50")) +
  ylab("Error variance")


by_site_CT_box_true_scanner <- between_error_CT_scanner %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12)) +
  ylab("Between-subjects variance")


by_site_ICC_CT_scanner <- between_error_CT_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(site) %>%
  summarise(m_ICC = median(ICC),
            m_error = median(error_var)) %>%
  ggplot(aes(x = reorder(site, -m_error),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank()) +
  ylab("ICC")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure5_CT_scanners.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure_5_scanner <- by_site_CT_box_true_scanner + by_site_CT_box_error_scanner + by_site_ICC_CT_scanner + plot_layout(widths = c(4,4,1))

print(Figure_5_scanner)

 dev.off()
 }


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure5_CT_scanner_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
 Figure_5_CT_scanner_sim <- by_site_CT_box_true_scanner + by_site_CT_box_error_scanner + by_site_ICC_CT_scanner + plot_layout(widths = c(4,4,1))
 
 print(Figure_5_CT_scanner_sim)
 
 dev.off()
 }

```

# by site within scanners - CT


```{r multigroup_CFIs_CT_Philips}
#multigroup_CFIs_CT_Philips <- read.csv("2_analysis_output/multigroup_CFIs_CT_Philips.csv")

multigroup_CFIs_CT_Philips <- multigroup_CFIs_CT_Philips %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_CT_Philips <- multigroup_CFIs_CT_Philips %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_CT_Philips <- multigroup_CFIs_CT_Philips %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_CT_Philips %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_CT_Philips %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_CT_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Philips, max_deltaCFI_CT_Philips),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_CT_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Philips, max_deltaCFI_CT_Philips),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_CT_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Philips, max_deltaCFI_CT_Philips),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_CT_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Philips, max_deltaCFI_CT_Philips),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_CT_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Philips, max_deltaCFI_CT_Philips),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_CT_Philips.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_CT_Philips <- deltaCFI_errcon_v_con_CT_Philips / deltaCFI_uncon_v_errcon_CT_Philips / deltaCFI_timecon_v_con_CT_Philips / deltaCFI_uncon_v_timecon_CT_Philips / deltaCFI_uncon_v_con_CT_Philips + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_CT_Philips)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_CT_Philips_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
 Figure7_CT_Philips_sim <- deltaCFI_errcon_v_con_CT_Philips / deltaCFI_uncon_v_errcon_CT_Philips / deltaCFI_timecon_v_con_CT_Philips / deltaCFI_uncon_v_timecon_CT_Philips / deltaCFI_uncon_v_con_CT_Philips + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_CT_Philips_sim)
 
 dev.off()
 }
```

```{r multigroup_CFIs_CT_GE}
#multigroup_CFIs_CT_GE <- read.csv("2_analysis_output/multigroup_CFIs_CT_GE.csv")


multigroup_CFIs_CT_GE <- multigroup_CFIs_CT_GE %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_CT_GE <- multigroup_CFIs_CT_GE %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_CT_GE <- multigroup_CFIs_CT_GE %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_CT_GE %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_CT_GE %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_CT_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_GE, max_deltaCFI_CT_GE),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_CT_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_GE, max_deltaCFI_CT_GE),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_CT_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_GE, max_deltaCFI_CT_GE),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_CT_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_GE, max_deltaCFI_CT_GE),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_CT_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_GE, max_deltaCFI_CT_GE),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_CT_GE.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_GE <- deltaCFI_errcon_v_con_CT_GE / deltaCFI_uncon_v_errcon_CT_GE / deltaCFI_timecon_v_con_CT_GE / deltaCFI_uncon_v_timecon_CT_GE / deltaCFI_uncon_v_con_CT_GE + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_GE)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_CT_GE_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_CT_GE_sim <- deltaCFI_errcon_v_con_CT_GE / deltaCFI_uncon_v_errcon_CT_GE / deltaCFI_timecon_v_con_CT_GE / deltaCFI_uncon_v_timecon_CT_GE / deltaCFI_uncon_v_con_CT_GE + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_CT_GE_sim)
 
 dev.off()
 }
```

```{r multigroup_CFIs_CT_Siemens}

#multigroup_CFIs_CT_Siemens <- read.csv("2_analysis_output/multigroup_CFIs_CT_Siemens.csv")
multigroup_CFIs_CT_Siemens <- multigroup_CFIs_CT_Siemens %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_CT_Siemens <- multigroup_CFIs_CT_Siemens %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_CT_Siemens <- multigroup_CFIs_CT_Siemens %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_CT_Siemens %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_CT_Siemens %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_CT_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Siemens, max_deltaCFI_CT_Siemens),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_CT_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Siemens, max_deltaCFI_CT_Siemens),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_CT_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Siemens, max_deltaCFI_CT_Siemens),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_CT_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Siemens, max_deltaCFI_CT_Siemens),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_CT_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_CT_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_CT_Siemens, max_deltaCFI_CT_Siemens),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_CT_Siemens.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_CT_Siemens <- deltaCFI_errcon_v_con_CT_Siemens / deltaCFI_uncon_v_errcon_CT_Siemens / deltaCFI_timecon_v_con_CT_Siemens / deltaCFI_uncon_v_timecon_CT_Siemens / deltaCFI_uncon_v_con_CT_Siemens + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_CT_Siemens)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_CT_Siemens_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_CT_Siemens_sim <- deltaCFI_errcon_v_con_CT_Siemens / deltaCFI_uncon_v_errcon_CT_Siemens / deltaCFI_timecon_v_con_CT_Siemens / deltaCFI_uncon_v_timecon_CT_Siemens / deltaCFI_uncon_v_con_CT_Siemens + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_CT_Siemens_sim)
 
 dev.off()
 }
```


# by scanners - SA

```{r multigroup_CFIs_SA_scanners}
#multigroup_CFIs_SA_scanners <- read.csv("2_analysis_output/multigroup_CFIs_SA_scanners.csv")

multigroup_CFIs_SA_scanners <- multigroup_CFIs_SA_scanners %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_SA_scanners <- multigroup_CFIs_SA_scanners %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_SA_scanners <- multigroup_CFIs_SA_scanners %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_SA_scanners %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_SA_scanners %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_SA_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_scanners, max_deltaCFI_SA_scanners),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_SA_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_scanners, max_deltaCFI_SA_scanners),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_SA_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_scanners, max_deltaCFI_SA_scanners),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_SA_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_scanners, max_deltaCFI_SA_scanners),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_SA_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_scanners, max_deltaCFI_SA_scanners),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_SA_scanners.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_scanners <- deltaCFI_errcon_v_con_SA_scanners / deltaCFI_uncon_v_errcon_SA_scanners / deltaCFI_timecon_v_con_SA_scanners / deltaCFI_uncon_v_timecon_SA_scanners / deltaCFI_uncon_v_con_SA_scanners + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_scanners)

 dev.off()
 }


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_SA_scanners_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_scanners_sim <- deltaCFI_errcon_v_con_SA_scanners / deltaCFI_uncon_v_errcon_SA_scanners / deltaCFI_timecon_v_con_SA_scanners / deltaCFI_uncon_v_timecon_SA_scanners / deltaCFI_uncon_v_con_SA_scanners + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

 
 print(Figure7_scanners_sim)
 
 dev.off()
 }

```

```{r betweenanderrormain_SA_regions_scanners}

by_ROI_SA_box_error_scanner <- between_error_SA_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.title.x = element_text(size = 14)) +
  ylab("Error variance")

by_ROI_SA_box_time_scanner <- between_error_SA_scanner %>%
    filter(grepl("rh_", ROI)) %>%
    mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14)) +
  ylab("Between-subjects variance")

by_ROI_ICC_SA_scanner <- between_error_SA_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(ROI) %>%
  summarise(m_ICC = median(ICC),
            m_time = median(time_var)) %>%
  ggplot(aes(x = reorder(ROI, -m_time),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.title.x = element_text(size = 14)) +
  ylab("ICC")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure4_SA_scanners.png",
       type = "png",
       units="in", 
       width=8, 
       height=8, 
       pointsize=12, 
       dpi=600)

Figure_4_scanner <- by_ROI_SA_box_time_scanner + by_ROI_SA_box_error_scanner + by_ROI_ICC_SA_scanner + plot_layout(widths = c(4,4,1))

print(Figure_4_scanner)

 dev.off()
 }
 
 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure4_SA_scanner_sim.png",
       type = "png",
       units="in", 
       width=8, 
       height=8, 
       pointsize=12, 
       dpi=600)
 
Figure_4_scanner_sim <- by_ROI_SA_box_time_scanner + by_ROI_SA_box_error_scanner + by_ROI_ICC_SA_scanner + plot_layout(widths = c(4,4,1))

print(Figure_4_scanner_sim)
 
 dev.off()
 }


```

```{r betweenanderrormain_SA_sites_scanners}

between_error_SA_scanner %>%
  group_by(ROI, site) %>%
  summarise(median_t = median(time_var),
            median_e = median(error_var)) %>%
  ungroup() %>%
  summarise(median_t2 = median(median_t),
            quantilet25 = quantile(median_t, .1),
            quantilet75 = quantile(median_t, .9),

            median_e2 = median(median_e),
            quantilee25 = quantile(median_e, .1),
            quantilee75 = quantile(median_e, .9))


#################

by_site_SA_box_error_scanner <- between_error_SA_scanner %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50")) +
  ylab("Error variance")


by_site_SA_box_true_scanner <- between_error_SA_scanner %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12)) +
  ylab("Between-subjects variance")


by_site_ICC_SA_scanner <- between_error_SA_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(site) %>%
  summarise(m_ICC = median(ICC),
            m_error = median(error_var)) %>%
  ggplot(aes(x = reorder(site, -m_error),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank()) +
  ylab("ICC")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure5_SA_scanners.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure_5_scanner <- by_site_SA_box_true_scanner + by_site_SA_box_error_scanner + by_site_ICC_SA_scanner + plot_layout(widths = c(4,4,1))

print(Figure_5_scanner)

 dev.off()
 }


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure5_SA_scanner_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
 Figure_5_SA_scanner_sim <- by_site_SA_box_true_scanner + by_site_SA_box_error_scanner + by_site_ICC_SA_scanner + plot_layout(widths = c(4,4,1))
 
 print(Figure_5_SA_scanner_sim)
 
 dev.off()
 }

```

# by site within scanners - SA


```{r multigroup_CFIs_SA_Philips}
#multigroup_CFIs_SA_Philips <- read.csv("2_analysis_output/multigroup_CFIs_SA_Philips.csv")

multigroup_CFIs_SA_Philips <- multigroup_CFIs_SA_Philips %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_SA_Philips <- multigroup_CFIs_SA_Philips %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_SA_Philips <- multigroup_CFIs_SA_Philips %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_SA_Philips %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_SA_Philips %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_SA_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Philips, max_deltaCFI_SA_Philips),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_SA_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Philips, max_deltaCFI_SA_Philips),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_SA_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Philips, max_deltaCFI_SA_Philips),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_SA_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Philips, max_deltaCFI_SA_Philips),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_SA_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Philips, max_deltaCFI_SA_Philips),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_SA_Philips.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_SA_Philips <- deltaCFI_errcon_v_con_SA_Philips / deltaCFI_uncon_v_errcon_SA_Philips / deltaCFI_timecon_v_con_SA_Philips / deltaCFI_uncon_v_timecon_SA_Philips / deltaCFI_uncon_v_con_SA_Philips + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_SA_Philips)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_SA_Philips_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
 Figure7_SA_Philips_sim <- deltaCFI_errcon_v_con_SA_Philips / deltaCFI_uncon_v_errcon_SA_Philips / deltaCFI_timecon_v_con_SA_Philips / deltaCFI_uncon_v_timecon_SA_Philips / deltaCFI_uncon_v_con_SA_Philips + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_SA_Philips_sim)
 
 dev.off()
 }
```

```{r multigroup_CFIs_SA_GE}
#multigroup_CFIs_SA_GE <- read.csv("2_analysis_output/multigroup_CFIs_SA_GE.csv")


multigroup_CFIs_SA_GE <- multigroup_CFIs_SA_GE %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_SA_GE <- multigroup_CFIs_SA_GE %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_SA_GE <- multigroup_CFIs_SA_GE %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_SA_GE %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_SA_GE %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_SA_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_GE, max_deltaCFI_SA_GE),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_SA_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_GE, max_deltaCFI_SA_GE),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_SA_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_GE, max_deltaCFI_SA_GE),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_SA_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_GE, max_deltaCFI_SA_GE),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_SA_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_GE, max_deltaCFI_SA_GE),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_SA_GE.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_GE <- deltaCFI_errcon_v_con_SA_GE / deltaCFI_uncon_v_errcon_SA_GE / deltaCFI_timecon_v_con_SA_GE / deltaCFI_uncon_v_timecon_SA_GE / deltaCFI_uncon_v_con_SA_GE + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_GE)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_SA_GE_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_SA_GE_sim <- deltaCFI_errcon_v_con_SA_GE / deltaCFI_uncon_v_errcon_SA_GE / deltaCFI_timecon_v_con_SA_GE / deltaCFI_uncon_v_timecon_SA_GE / deltaCFI_uncon_v_con_SA_GE + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_SA_GE_sim)
 
 dev.off()
 }
```

```{r multigroup_CFIs_SA_Siemens}

#multigroup_CFIs_SA_Siemens <- read.csv("2_analysis_output/multigroup_CFIs_SA_Siemens.csv")
multigroup_CFIs_SA_Siemens <- multigroup_CFIs_SA_Siemens %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_SA_Siemens <- multigroup_CFIs_SA_Siemens %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_SA_Siemens <- multigroup_CFIs_SA_Siemens %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_SA_Siemens %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_SA_Siemens %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_SA_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Siemens, max_deltaCFI_SA_Siemens),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_SA_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Siemens, max_deltaCFI_SA_Siemens),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_SA_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Siemens, max_deltaCFI_SA_Siemens),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_SA_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Siemens, max_deltaCFI_SA_Siemens),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_SA_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_SA_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_SA_Siemens, max_deltaCFI_SA_Siemens),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_SA_Siemens.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_SA_Siemens <- deltaCFI_errcon_v_con_SA_Siemens / deltaCFI_uncon_v_errcon_SA_Siemens / deltaCFI_timecon_v_con_SA_Siemens / deltaCFI_uncon_v_timecon_SA_Siemens / deltaCFI_uncon_v_con_SA_Siemens + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_SA_Siemens)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_SA_Siemens_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_SA_Siemens_sim <- deltaCFI_errcon_v_con_SA_Siemens / deltaCFI_uncon_v_errcon_SA_Siemens / deltaCFI_timecon_v_con_SA_Siemens / deltaCFI_uncon_v_timecon_SA_Siemens / deltaCFI_uncon_v_con_SA_Siemens + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_SA_Siemens_sim)
 
 dev.off()
 }
```


# by scanners - GM

```{r multigroup_CFIs_GM_scanners}
#multigroup_CFIs_GM_scanners <- read.csv("2_analysis_output/multigroup_CFIs_GM_scanners.csv")

multigroup_CFIs_GM_scanners <- multigroup_CFIs_GM_scanners %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_GM_scanners <- multigroup_CFIs_GM_scanners %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_GM_scanners <- multigroup_CFIs_GM_scanners %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_GM_scanners %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_GM_scanners %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_GM_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_scanners, max_deltaCFI_GM_scanners),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_GM_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_scanners, max_deltaCFI_GM_scanners),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_GM_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_scanners, max_deltaCFI_GM_scanners),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_GM_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_scanners, max_deltaCFI_GM_scanners),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_GM_scanners <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_scanners, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_scanners, max_deltaCFI_GM_scanners),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_GM_scanners.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_scanners <- deltaCFI_errcon_v_con_GM_scanners / deltaCFI_uncon_v_errcon_GM_scanners / deltaCFI_timecon_v_con_GM_scanners / deltaCFI_uncon_v_timecon_GM_scanners / deltaCFI_uncon_v_con_GM_scanners + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_scanners)

 dev.off()
 }


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_GM_scanners_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_scanners_sim <- deltaCFI_errcon_v_con_GM_scanners / deltaCFI_uncon_v_errcon_GM_scanners / deltaCFI_timecon_v_con_GM_scanners / deltaCFI_uncon_v_timecon_GM_scanners / deltaCFI_uncon_v_con_GM_scanners + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

 
 print(Figure7_scanners_sim)
 
 dev.off()
 }

```

```{r betweenanderrormain_GM_regions_scanners}

by_ROI_GM_box_error_scanner <- between_error_GM_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.title.x = element_text(size = 14)) +
  ylab("Error variance")

by_ROI_GM_box_time_scanner <- between_error_GM_scanner %>%
    filter(grepl("rh_", ROI)) %>%
    mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  ggplot(aes(x = reorder(ROI, -time_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14)) +
  ylab("Between-subjects variance")

by_ROI_ICC_GM_scanner <- between_error_GM_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(ROI) %>%
  summarise(m_ICC = median(ICC),
            m_time = median(time_var)) %>%
  ggplot(aes(x = reorder(ROI, -m_time),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.title.x = element_text(size = 14)) +
  ylab("ICC")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure4_GM_scanners.png",
       type = "png",
       units="in", 
       width=8, 
       height=8, 
       pointsize=12, 
       dpi=600)

Figure_4_scanner <- by_ROI_GM_box_time_scanner + by_ROI_GM_box_error_scanner + by_ROI_ICC_GM_scanner + plot_layout(widths = c(4,4,1))

print(Figure_4_scanner)

 dev.off()
 }
 
 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure4_GM_scanner_sim.png",
       type = "png",
       units="in", 
       width=8, 
       height=8, 
       pointsize=12, 
       dpi=600)
 
Figure_4_scanner_sim <- by_ROI_GM_box_time_scanner + by_ROI_GM_box_error_scanner + by_ROI_ICC_GM_scanner + plot_layout(widths = c(4,4,1))

print(Figure_4_scanner_sim)
 
 dev.off()
 }


```

```{r betweenanderrormain_GM_sites_scanners}

between_error_GM_scanner %>%
  group_by(ROI, site) %>%
  summarise(median_t = median(time_var),
            median_e = median(error_var)) %>%
  ungroup() %>%
  summarise(median_t2 = median(median_t),
            quantilet25 = quantile(median_t, .1),
            quantilet75 = quantile(median_t, .9),

            median_e2 = median(median_e),
            quantilee25 = quantile(median_e, .1),
            quantilee75 = quantile(median_e, .9))


#################

by_site_GM_box_error_scanner <- between_error_GM_scanner %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = error_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50")) +
  ylab("Error variance")


by_site_GM_box_true_scanner <- between_error_GM_scanner %>%
  ggplot(aes(x = reorder(site, -error_var, FUN = median),
             y = time_var)) +
  geom_point(aes(colour = site),
             position = position_jitter(width = .25),
             size = 1.3) +
      geom_boxplot(outlier.shape = NA, 
                   width = .8, 
                   colour = "BLACK",
                   alpha = 0.2,
                   size = .3) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey50"),
        axis.text.y = element_text(size = 12)) +
  ylab("Between-subjects variance")


by_site_ICC_GM_scanner <- between_error_GM_scanner %>%
  filter(grepl("rh_", ROI)) %>%
  mutate(ROI = str_replace(ROI, "rh_", "")) %>%
  group_by(site) %>%
  summarise(m_ICC = median(ICC),
            m_error = median(error_var)) %>%
  ggplot(aes(x = reorder(site, -m_error),
             y = "ICC")) +
   geom_text(aes(label = round(m_ICC,2)),
            size = 3.5) +
   coord_flip() +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank()) +
  ylab("ICC")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure5_GM_scanners.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure_5_scanner <- by_site_GM_box_true_scanner + by_site_GM_box_error_scanner + by_site_ICC_GM_scanner + plot_layout(widths = c(4,4,1))

print(Figure_5_scanner)

 dev.off()
 }


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure5_GM_scanner_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
 Figure_5_GM_scanner_sim <- by_site_GM_box_true_scanner + by_site_GM_box_error_scanner + by_site_ICC_GM_scanner + plot_layout(widths = c(4,4,1))
 
 print(Figure_5_GM_scanner_sim)
 
 dev.off()
 }

```

# by site within scanners - GM


```{r multigroup_CFIs_GM_Philips}
#multigroup_CFIs_GM_Philips <- read.csv("2_analysis_output/multigroup_CFIs_GM_Philips.csv")

multigroup_CFIs_GM_Philips <- multigroup_CFIs_GM_Philips %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_GM_Philips <- multigroup_CFIs_GM_Philips %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_GM_Philips <- multigroup_CFIs_GM_Philips %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_GM_Philips %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_GM_Philips %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_GM_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Philips, max_deltaCFI_GM_Philips),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_GM_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Philips, max_deltaCFI_GM_Philips),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_GM_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Philips, max_deltaCFI_GM_Philips),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_GM_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Philips, max_deltaCFI_GM_Philips),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_GM_Philips <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Philips, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Philips, max_deltaCFI_GM_Philips),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_GM_Philips.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_GM_Philips <- deltaCFI_errcon_v_con_GM_Philips / deltaCFI_uncon_v_errcon_GM_Philips / deltaCFI_timecon_v_con_GM_Philips / deltaCFI_uncon_v_timecon_GM_Philips / deltaCFI_uncon_v_con_GM_Philips + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_GM_Philips)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_GM_Philips_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
 Figure7_GM_Philips_sim <- deltaCFI_errcon_v_con_GM_Philips / deltaCFI_uncon_v_errcon_GM_Philips / deltaCFI_timecon_v_con_GM_Philips / deltaCFI_uncon_v_timecon_GM_Philips / deltaCFI_uncon_v_con_GM_Philips + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_GM_Philips_sim)
 
 dev.off()
 }
```

```{r multigroup_CFIs_GM_GE}
#multigroup_CFIs_GM_GE <- read.csv("2_analysis_output/multigroup_CFIs_GM_GE.csv")


multigroup_CFIs_GM_GE <- multigroup_CFIs_GM_GE %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_GM_GE <- multigroup_CFIs_GM_GE %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_GM_GE <- multigroup_CFIs_GM_GE %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_GM_GE %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_GM_GE %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_GM_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_GE, max_deltaCFI_GM_GE),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_GM_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_GE, max_deltaCFI_GM_GE),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_GM_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_GE, max_deltaCFI_GM_GE),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_GM_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_GE, max_deltaCFI_GM_GE),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_GM_GE <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_GE, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_GE, max_deltaCFI_GM_GE),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_GM_GE.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_GE <- deltaCFI_errcon_v_con_GM_GE / deltaCFI_uncon_v_errcon_GM_GE / deltaCFI_timecon_v_con_GM_GE / deltaCFI_uncon_v_timecon_GM_GE / deltaCFI_uncon_v_con_GM_GE + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_GE)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_GM_GE_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_GM_GE_sim <- deltaCFI_errcon_v_con_GM_GE / deltaCFI_uncon_v_errcon_GM_GE / deltaCFI_timecon_v_con_GM_GE / deltaCFI_uncon_v_timecon_GM_GE / deltaCFI_uncon_v_con_GM_GE + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_GM_GE_sim)
 
 dev.off()
 }
```

```{r multigroup_CFIs_GM_Siemens}

#multigroup_CFIs_GM_Siemens <- read.csv("2_analysis_output/multigroup_CFIs_GM_Siemens.csv")
multigroup_CFIs_GM_Siemens <- multigroup_CFIs_GM_Siemens %>%
  mutate(errcon_v_con = m_e_constrained - m_constrained,
         uncon_v_errcon = m_unconstrained - m_e_constrained,
         timecon_v_con = m_time_constrained - m_constrained,
         uncon_v_timecon = m_unconstrained - m_time_constrained,
         uncon_v_con = m_unconstrained - m_constrained)

min_deltaCFI_GM_Siemens <- multigroup_CFIs_GM_Siemens %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  min(na.rm = TRUE)

max_deltaCFI_GM_Siemens <- multigroup_CFIs_GM_Siemens %>%
  select(errcon_v_con, uncon_v_errcon, timecon_v_con, uncon_v_timecon, uncon_v_con) %>%
  max(na.rm = TRUE)

# for added info

multigroup_CFIs_GM_Siemens %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_01 = sum(deltaCFI > .01)/n(),
            n_02 = sum(deltaCFI > .02)/n())
# 1 errcon_v_con    0.324  0.191
# 2 timecon_v_con   0.985  0.971
# 3 uncon_v_con     0.985  0.985
# 4 uncon_v_errcon  0.985  0.971
# 5 uncon_v_timecon 0.0441 0 


multigroup_CFIs_GM_Siemens %>%
  pivot_longer(cols = c(errcon_v_con,
uncon_v_errcon,
timecon_v_con,
uncon_v_timecon,
uncon_v_con),
               names_to = "model",
               values_to = "deltaCFI") %>%
  group_by(model) %>%
  summarise(n_0 = sum(deltaCFI < 0)/n())

deltaCFI_errcon_v_con_GM_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = errcon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Siemens, max_deltaCFI_GM_Siemens),
                        type = "viridis") +
  ggtitle("A. Constrained vs Between-subjects varying")

deltaCFI_uncon_v_errcon_GM_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_errcon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Siemens, max_deltaCFI_GM_Siemens),
                        type = "viridis") +
  ggtitle("B. Between-subjects varying vs Unconstrained")

deltaCFI_timecon_v_con_GM_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = timecon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Siemens, max_deltaCFI_GM_Siemens),
                        type = "viridis") +
  ggtitle("C. Constrained vs Error varying")

deltaCFI_uncon_v_timecon_GM_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_timecon)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Siemens, max_deltaCFI_GM_Siemens),
                        type = "viridis") +
  ggtitle("D. Error varying vs Unconstrained")

deltaCFI_uncon_v_con_GM_Siemens <- dk %>% 
  as_tibble() %>% 
  left_join(multigroup_CFIs_GM_Siemens, by = c("label" = "region")) %>%
ggseg(., atlas = "dk", 
        colour = "black",
        size = .1,
        mapping = aes(fill = uncon_v_con)) +
    theme_void() +
  scale_fill_continuous(name = "delta CFI",
                        limits = c(min_deltaCFI_GM_Siemens, max_deltaCFI_GM_Siemens),
                        type = "viridis") +
  ggtitle("E. Constrained vs Unconstrained")

 if(use_sim == FALSE){
 Cairo(file = "8_supplement/Figure7_GM_Siemens.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)

Figure7_GM_Siemens <- deltaCFI_errcon_v_con_GM_Siemens / deltaCFI_uncon_v_errcon_GM_Siemens / deltaCFI_timecon_v_con_GM_Siemens / deltaCFI_uncon_v_timecon_GM_Siemens / deltaCFI_uncon_v_con_GM_Siemens + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)

print(Figure7_GM_Siemens)

 dev.off()
}


 if(use_sim == TRUE){
 Cairo(file = "9_supplement_simulated/Figure7_GM_Siemens_sim.png",
       type = "png",
       units="in", 
       width=6, 
       height=6, 
       pointsize=12, 
       dpi=600)
 
Figure7_GM_Siemens_sim <- deltaCFI_errcon_v_con_GM_Siemens / deltaCFI_uncon_v_errcon_GM_Siemens / deltaCFI_timecon_v_con_GM_Siemens / deltaCFI_uncon_v_timecon_GM_Siemens / deltaCFI_uncon_v_con_GM_Siemens + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.key.width = unit(1, "cm"), legend.title.align=0.5)
 
 print(Figure7_GM_Siemens_sim)
 
 dev.off()
 }
```



# 3. Practical implications
# D-study for CT

```{r d_study}
out_CT$d_9 <- ceiling((9*out_CT$eest) / out_CT$timeest)


sum(out_CT$d_9 >= 2, na.rm = TRUE) / length(out_CT$d_9) # 67 - 98.5%
sum(out_CT$d_9 >= 3, na.rm = TRUE) / length(out_CT$d_9) # 48 - 70.6%
sum(out_CT$d_9 >= 4, na.rm = TRUE) / length(out_CT$d_9) # 31 - 45.6%
sum(out_CT$d_9 >= 5, na.rm = TRUE) / length(out_CT$d_9) # 14 - 20.6%
sum(out_CT$d_9 >= 6, na.rm = TRUE) / length(out_CT$d_9) # 5  -  7.3%
sum(out_CT$d_9 >= 7, na.rm = TRUE) / length(out_CT$d_9) # 2  -  2.9%
sum(out_CT$d_9 >= 8, na.rm = TRUE) / length(out_CT$d_9) # 2
sum(out_CT$d_9 >= 9, na.rm = TRUE) / length(out_CT$d_9) # 0

# specifics
out_CT %>%
  filter(d_9 >= 8)

# 
CT_d_hist <- out_CT %>%
  na.omit() %>%
  ggplot(aes(x = d_9, fill = cut(d_9, breaks = 0:8))) +
  geom_bar(aes(y = (..count..))) +
  theme(legend.position = "none") +
  ylab("number of regions") +
  scale_fill_viridis_d(option = "E",
                       direction = -1) +
  xlab("number of repeated measures to achieve statistical power above 0.9")

comb_CT_d <- dk %>% 
  as_tibble() %>% 
  left_join(out_CT) %>%
    na.omit()

CT_d_9 <- comb_CT_d %>%
    na.omit() %>%
    ggseg(atlas = dk, 
      colour = "black",
      size = .1, 
      #position = "stacked",
      mapping = aes(fill = as.factor(d_9))) +
  theme(legend.title = element_blank()) +
    scale_fill_viridis_d(na.translate = F,
                         option = "E",
                         direction = -1)
#    scale_fill_continuous(limits = c(1:9)) +
#  ggtitle("Cortical Thickness")

Cairo(file = "6_figures/Figure8.png",
      type = "png",
      units="in", 
      width=6, 
      height=4, 
      pointsize=12, 
      dpi=600)

CT_d_9 + CT_d_hist +  plot_layout(guides = "collect", 
                                 heights = c(2,3))

dev.off()
```

# power example

```{r power_example}

.3*sqrt(.9*.9)
.3*sqrt(.9*.54)


out_CT %>%
  filter(ICC == min(ICC) | ICC == max(ICC) ) %>%
  arrange(ICC)

pwr::pwr.r.test(r = .27, power = .8) # n = 104
pwr::pwr.r.test(r = .21, power = .8) # n = 175

```

